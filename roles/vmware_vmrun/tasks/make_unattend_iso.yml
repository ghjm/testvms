- name: Create tmp directory
  file:
    path: "{{ vm_path }}"
    state: directory
  delegate_to: localhost

- name: Copy items to tmp folder
  template:
    src: "{{ item }}"
    dest: "{{ vm_path }}/{{ item }}"
  with_items:
    - autounattend.xml
    - SetIPAddress.bat
    - ConfigureRemotingForAnsible.ps1
  register: tmp_files
  delegate_to: localhost

- name: Create autounattend ISO
  command: "\"{{ vmware_library_path }}/mkisofs\" -o \"{{ kickstart_iso_filename }}\" -R -J -V -T {{ tmp_files.results|map(attribute='item')|join(' ') }}"
  args:
    chdir: "{{ vm_path }}"
  delegate_to: localhost

- name: Remove temporary files
  file:
    path: "{{ vm_path }}/{{ item }}"
    state: absent
  with_items: "{{ tmp_files.results|map(attribute='item')|shuffle }}"
  delegate_to: localhost

